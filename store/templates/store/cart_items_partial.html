{% load static %}




{% for item in mini_panier_produits %}
<li class="header-cart-item flex-w flex-t m-b-12">
    <div class="header-cart-item-img" style="position: relative;">
        {% with item.couleur.images.first as img %}
            {% if img %}
                <img src="{{ img.image.url }}" alt="{{ item.produit.nom }}">
            {% else %}
                <img src="{% static 'store/images/default.png' %}" alt="no image">
            {% endif %}
        {% endwith %}

        <!-- Ø²Ø± Ø§Ù„Ø¥Ø²Ø§Ù„Ø© ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© -->
       <button class="remove-btn-sidebar"
        data-id="{{ item.id }}"
        style="position:absolute; top:-5px; right:0px; padding:4px; border-radius:50%; color:red; z-index:999; background: transparent; border:none; cursor:pointer;">
          <i class="fa fa-times"></i>
        </button>


    </div>

    <div class="header-cart-item-txt p-t-8">
        <a href="{% url 'product_detail' item.produit.id %}" class="header-cart-item-name m-b-18 hov-cl1 trans-04">
            {{ item.produit.nom }} :  {{ item.couleur.couleur }}
             |    {{ item.taille }}
        </a>
        <span class="header-cart-item-info">
            {{ item.quantite }} Ã— {{ item.produit.prix }} DA

        </span>
    </div>

</li>
{% empty %}
    <li class="header-cart-item m-b-12">
        <span class="stext-101 cl6">PANIER VIDE ğŸ›’</span>
    </li>

{% endfor %}

<!-- âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ -->
{% if total_produits > 0 %}
    <div class="header-cart-total w-full p-tb-20" style="text-align: center;">
         TOTAL : <strong>{{ total_produits }} DA</strong>
    </div>
{% endif %}



<div class="w-full">
<!--					<div class="header-cart-total w-full p-tb-40">-->
<!--						<ul class="header-cart-wrapitem w-full">-->
<!--    						ğŸ§¾ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: {{ total|floatformat:2 }} DA-->
<!--						</ul>-->
<!--					</div>-->


					<div class="header-cart-buttons flex-w w-full">
						<a href="{% url 'panier' %}" class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-r-8 m-b-10">
							LANCER LA COMMANDE
						</a>

<!--						<a href="shoping-cart.html" class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-b-10">-->
<!--							Check Out-->
<!--						</a>-->
					</div>
				</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const cartBtn = document.querySelector(".js-show-cart");
    const cartPanel = document.querySelector(".js-panel-cart");
    const cartClose = document.querySelectorAll(".js-hide-cart");

    if (cartBtn && cartPanel) {
        cartBtn.addEventListener("click", function () {
            cartPanel.classList.add("show-header-cart");
        });
    }

    cartClose.forEach(btn => {
        btn.addEventListener("click", function () {
            cartPanel.classList.remove("show-header-cart");
        });
    });
});
</script>
<script>
function updateCarts(data, itemId = null) {
    // âœ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
    if (itemId) {
        const li = document.querySelector(`.remove-btn-sidebar[data-id='${itemId}']`)?.closest(".header-cart-item");
        if (li) li.remove();
    }


        // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… ÙÙˆÙ‚ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ù„Ø© (ÙƒÙ…Ø¨ÙŠÙˆØªØ± + Ù‡Ø§ØªÙ)
    document.querySelectorAll(".icon-header-noti, .js-show-cart").forEach(el => {
      el.setAttribute("data-notify", data.count || 0);
    });


    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ÙÙŠ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    const totalDiv = document.querySelector(".header-cart-total strong");
    if (totalDiv) totalDiv.textContent = data.total_produits + " DA";

    // âœ… Ø¥Ø°Ø§ Ø§Ù„Ø³Ù„Ø© ØµØ§Ø±Øª ÙØ§Ø±ØºØ©
    if (document.querySelectorAll(".header-cart-item-img").length === 0) {
        const emptyMsg = document.createElement("li");
        emptyMsg.className = "header-cart-item m-b-12";
        emptyMsg.innerHTML = '<span class="stext-101 cl6">PANIER VIDE ğŸ›’</span>';

        document.querySelector(".header-cart-buttons")?.insertAdjacentElement("beforebegin", emptyMsg);
        document.querySelector(".header-cart-total")?.remove();
    }

    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© (ØµÙØ­Ø© panier)
    if (document.getElementById("prix-produits")) {
        document.getElementById("prix-produits").textContent = data.total_produits + " DA";
        document.getElementById("total_final").textContent = data.total_final + " DA";
        if (itemId) {
            const row = document.querySelector(`.btn-remove[data-id='${itemId}']`)?.closest("tr");
            if (row) row.remove();
        }
    }

    // ğŸ”‘ Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù Ø¨Ø¹Ø¯ Ø£ÙŠ ØªØ­Ø¯ÙŠØ«
    handleRemove(".remove-btn-sidebar");
    handleRemove(".btn-remove");
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ø­Ø°Ù Ù„ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
function handleRemove(buttonSelector) {
    document.querySelectorAll(buttonSelector).forEach(button => {
        if (!button.dataset.listenerAdded) { // Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
            button.dataset.listenerAdded = "true";

            button.addEventListener("click", function(e) {
                e.preventDefault();
                if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;

                const itemId = this.dataset.id;
                const body = new URLSearchParams();

                // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ÙÙ‚Ø· Ù„Ù„Ø³Ù„Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©
                const wilayaSelect = document.getElementById("wilaya-select");
                const selectedWilaya = wilayaSelect ? wilayaSelect.value : null;
                const livraisonRadio = document.querySelector("input[name='type_livraison']:checked");
                const selectedLivraison = livraisonRadio ? livraisonRadio.value : null;
                if (selectedWilaya) body.append("wilaya", selectedWilaya);
                if (selectedLivraison) body.append("type_livraison", selectedLivraison);

                fetch("{% url 'remove_from_cart' 0 %}".replace("0", itemId), {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: body.toString()
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) updateCarts(data, itemId);
                })
                .catch(err => console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", err));
            });
        }
    });
}

// âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
handleRemove(".remove-btn-sidebar");
handleRemove(".btn-remove");
</script>


<style>
    .header-cart-item-img::before,
    .header-cart-item-img::after {
        display: none !important;
    }
</style>